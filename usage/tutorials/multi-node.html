

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Train on Multiple Nodes &mdash; AutoDist  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/customized.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Save and Restore Training" href="save-restore.html" />
    <link rel="prev" title="Getting Started" href="getting-started.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#using-autodist">Using AutoDist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#references-acknowledgements">References &amp; Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Train on Multiple Nodes</a></li>
<li class="toctree-l1"><a class="reference internal" href="save-restore.html">Save and Restore Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Train with Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="choose-strategy.html">Choose Strategy Builders</a></li>
<li class="toctree-l1"><a class="reference internal" href="customize-strategy.html">Customize a Strategy Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../design/rationale.html">Rationale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../design/kernels.html">Graph Transformation Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proto_docgen.html">Strategy as ProtoBuf Message</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/autodist.html">Developer API References</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.checkpoint.html">Checkpoint</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.checkpoint.saved_model_builder.html">Saved Model Builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.checkpoint.saver.html">Saver</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.kernel.html">Kernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.common.html">Common</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.common.op_info.html">Op Info</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.common.proxy_variable.html">Proxy Variable</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.common.utils.html">Utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.common.variable_utils.html">Variable Utils</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.device.html">Device</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.device.resolver.html">Resolver</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.synchronization.html">Synchronization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.synchronization.all_reduce_synchronizer.html">All Reduce Synchronizer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.synchronization.collective_key.html">Collective Key</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.synchronization.compressor.html">Compressor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.synchronization.ps_synchronizer.html">Ps Synchronizer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/autodist.kernel.synchronization.synchronizer.html">Synchronizer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.graph_transformer.html">Graph Transformer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.kernel.html">Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.partitioner.html">Partitioner</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.kernel.replicator.html">Replicator</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.proto.html">Proto</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.proto.graphitem_pb2.html">Graphitem Pb2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.proto.strategy_pb2.html">Strategy Pb2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.proto.synchronizers_pb2.html">Synchronizers Pb2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.strategy.html">Strategy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.all_reduce_strategy.html">All Reduce Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.base.html">Base</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.parallax_strategy.html">Parallax Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.partitioned_all_reduce_strategy.html">Partitioned All Reduce Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.partitioned_ps_strategy.html">Partitioned Ps Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.ps_lb_strategy.html">Ps Lb Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.ps_strategy.html">Ps Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.random_axis_partition_all_reduce_strategy.html">Random Axis Partition All Reduce Strategy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.strategy.uneven_partition_ps_strategy.html">Uneven Partition Ps Strategy</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.utils.html">Utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.utils.logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.utils.network.html">Network</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.utils.server_starter.html">Server Starter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/autodist.utils.visualization_util.html">Visualization Util</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.autodist.html">Autodist</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.cluster.html">Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.const.html">Const</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.coordinator.html">Coordinator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.graph_item.html">Graph Item</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.patch.html">Patch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.remapper.html">Remapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.resource_spec.html">Resource Spec</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api/autodist.runner.html">Runner</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AutoDist</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Train on Multiple Nodes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/usage/tutorials/multi-node.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="train-on-multiple-nodes">
<h1>Train on Multiple Nodes<a class="headerlink" href="#train-on-multiple-nodes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="resource-specification">
<h2>Resource Specification<a class="headerlink" href="#resource-specification" title="Permalink to this headline">¶</a></h2>
<p>In tutorial <a class="reference internal" href="getting-started.html"><span class="doc">Getting Started</span></a>,
there is an example using the minimal resource specification in <code class="docutils literal notranslate"><span class="pre">yaml</span></code> format:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
    <span class="nt">gpus</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nv">1</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>However, we often need to train a large model with multiple nodes / virtual machines / pods etc.,
and at the same time with multiple accelerators.
Here is an example to define a resource specification for multi-node training:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">nodes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">172.31.30.187</span>
    <span class="nt">cpus</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">]</span>
    <span class="nt">gpus</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">3</span><span class="p p-Indicator">]</span>
    <span class="nt">chief</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="p p-Indicator">-</span> <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">172.31.18.140</span>
    <span class="nt">gpus</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">3</span><span class="p p-Indicator">]</span>
    <span class="nt">ssh_config</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh_conf1</span>
  <span class="p p-Indicator">-</span> <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">172.31.18.65</span>
    <span class="nt">cpus</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nv">1</span><span class="p p-Indicator">]</span>
    <span class="nt">gpus</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="nv">1</span><span class="p p-Indicator">]</span>
    <span class="nt">ssh_config</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ssh_conf2</span>

<span class="nt">ssh</span><span class="p">:</span>
  <span class="nt">ssh_conf1</span><span class="p">:</span>
    <span class="nt">key_file</span><span class="p">:</span> <span class="s">&#39;/home/ubuntu/.ssh/autodist.pem&#39;</span>
    <span class="nt">username</span><span class="p">:</span> <span class="s">&#39;ubuntu&#39;</span>
    <span class="nt">python_venv</span><span class="p">:</span> <span class="s">&#39;source</span><span class="nv"> </span><span class="s">/home/ubuntu/venvs/autodist/bin/activate&#39;</span>
  <span class="nt">ssh_conf2</span><span class="p">:</span>
    <span class="nt">key_file</span><span class="p">:</span> <span class="s">&#39;/home/ubuntu/.ssh/my_private_key&#39;</span>
    <span class="nt">username</span><span class="p">:</span> <span class="s">&#39;username&#39;</span>
    <span class="nt">python_venv</span><span class="p">:</span> <span class="s">&#39;source</span><span class="nv"> </span><span class="s">/home/username/anaconda3/etc/profile.d/conda.sh;conda</span><span class="nv"> </span><span class="s">activate</span><span class="nv"> </span><span class="s">autodist&#39;</span>
    <span class="nt">shared_envs</span><span class="p">:</span>
      <span class="nt">LD_LIBRARY_PATH</span><span class="p">:</span> <span class="s">&#39;$LD_LIBRARY_PATH:/usr/local/cuda/lib64&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nodes</span></code>: the computational nodes spec defined for distributed training.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">address</span></code> <em>str</em>: the ipv4 or ipv6 address to access the nodes.
Note that in a multiple-node scenario the resource specification is shared across the node,
and the address will be the identifier for communications across nodes in the cluster,
so one should avoid using <code class="docutils literal notranslate"><span class="pre">localhost</span></code> in such case to prevent ambiguity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpus</span></code> <em>List[int]</em> (optional): If not specified, it means only the first CPU will be utilized.
One can also specify multiple CPUs. However, it requires some careful treatment.
For example, if a strategy uses the extra CPU for data-parallel computation together with GPU,
it can slow down the performance. Even though in the future AutoDist will support
auto-generated strategies to utilize the extra CPUs smartly, the multiple CPUs strategy is still experimental in the current releases.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gpus</span></code> <em>List[int]</em> (optional): the CUDA device IDs of GPUs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">chief</span></code> <em>bool</em> (optional): Optional for single-node training.
However, it is required to specify exactly one of the multiple nodes to be the <code class="docutils literal notranslate"><span class="pre">chief</span></code>.
The <code class="docutils literal notranslate"><span class="pre">chief</span></code> node should be the node you launch the program from (it will also participate in the training, so make sure it is a node in your cluster).</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssh</span></code>:  You also need to create <code class="docutils literal notranslate"><span class="pre">ssh_config</span></code>s that can be used by the <code class="docutils literal notranslate"><span class="pre">chief</span></code> node to ssh into all other nodes.
They must be named; this allows for having different ssh configs if, for example, different nodes have different private keys.
<code class="docutils literal notranslate"><span class="pre">ssh_conf1</span></code>, <code class="docutils literal notranslate"><span class="pre">ssh_conf2</span></code> can be any unique string to specify a group of configurations.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">key_file</span></code> <em>str</em>: key path on <strong><code class="docutils literal notranslate"><span class="pre">chief</span></code> node</strong> to use to connect the remote node via ssh</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">username</span></code> <em>str</em>: username to access the remote (non-chief) node with</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_venv</span></code> <em>str</em> (optional): the command to activate the virtual environment on a remote (non-chief) node.
If not provided, it will use the default system default <code class="docutils literal notranslate"><span class="pre">python</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shared_envs</span></code> <em>pair</em> (optional): the key-value environment variable pairs for a remote (non-chief) node to use</p></li>
</ul>
</li>
</ul>
<blockquote>
<div><p>In the current release, the multi-node coordination is based on SSH and Python virtual environments;
while other types of coordination are being actively developed.
For example to support for docker container instead of Python virtual environment, or
for K8 launching instead of SSH, etc.</p>
</div></blockquote>
</div>
<div class="section" id="environment-preparation">
<h2>Environment Preparation<a class="headerlink" href="#environment-preparation" title="Permalink to this headline">¶</a></h2>
<p>Below are the steps of setting up environments for multi-node training.
If you are familiar with Docker, you could skip the following and
follow this straight-forward <a class="reference internal" href="docker.html"><span class="doc">instruction</span></a> to directly launch with Docker.</p>
<p>Before running your program distributed with AutoDist on multiple nodes,</p>
<ol class="simple">
<li><p>The model should be able to train on each node successfully with AutoDist, as in
<a class="reference internal" href="getting-started.html"><span class="doc">Getting Started</span></a>.</p></li>
<li><p>The working directory containing project files should share the same absolute path on all nodes.
For example, if the working dir is <code class="docutils literal notranslate"><span class="pre">/home/username/myproject</span></code> on the node where you launch the program,
it is also required that your project files are placed under the same absolute path
for all the other nodes. Symbolic link is also allowed.</p></li>
<li><p>Note that the field <code class="docutils literal notranslate"><span class="pre">python_venv</span></code> requires the command to source remote env, <em>without</em> sourcing <code class="docutils literal notranslate"><span class="pre">~/.bash_rc</span></code> unless specified; while <code class="docutils literal notranslate"><span class="pre">shared_envs</span></code> is for passing the environment vars to the remote. For conda environments, <code class="docutils literal notranslate"><span class="pre">conda.sh</span></code> must be sourced before conda environment can be activated.</p></li>
</ol>
<p>Then one can launch the script from the chief machine.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="save-restore.html" class="btn btn-neutral float-right" title="Save and Restore Training" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="getting-started.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Petuum

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>